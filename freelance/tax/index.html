<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>年金・保険・税金の計算</title>
    <link href="./res/default.css" rel="stylesheet">
    <script src="./res/config.js"></script>
    <script src="../../res/js/my.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
</head>
<body>
    <div class="mask"><div class="loader"></div></div>
    <h1>個人事業主の税金計算（jquery版）</h1>
    <div id="content"></div>
</body>


<script>
$(function(){
    tax.render();
    $(document).on("change", `input[type="text"].amount, input[type="text"].age, input[type="text"].number`, function(){ tax.refresh($(this));});
    $(".mask").hide();
});

var tax = tax || {
    eval:(v)=>{
        if ($.type(v)=="string" && v.match(/^=/)) {
            console.log(eval(v.slice(1)));
            return Number(eval(v.slice(1)));
        }

        return Number(v);
    },
    render:()=>{
        $("#content").html(config.template);
        tax.refresh();
    },
    refresh:($el)=>{
        let total_income = total_cost = total_allowable = total_amount = 0;
        $(`input[type="text"].amount`).get().forEach(function(text){
            $text = $(text);
            let css_id = $text.prop("id");
            let css_id_common = $text.prop("id").replace(/input-yearly-/, "");

            let amount = tax.eval($text.val());
            let amount_monthly = (amount/12).toFixed(1);
            $(`#monthly-${css_id_common}`).text(amount ? amount_monthly : "");

            let plus_minuse = $text.hasClass("cost")? -1 : 1;

            // 合計収入
            total_income += $text.hasClass("income") ? plus_minuse*amount : 0;
            // 課税所得額
            total_amount += plus_minuse*amount;
            // 合計経費
            total_cost += css_id.match(/^input-yearly-2/) ? amount : 0;
            // 合計控除
            total_allowable += css_id.match(/^input-yearly-3/) ? amount : 0;
        });

        // 合計売上
        $(`#yearly-1-0`).text(total_income);
        // 合計経費
        $(`#yearly-2-0`).text(total_cost);
        // 合計控除
        $(`#yearly-3-0`).text(total_allowable);


        // 課税所得額
        $(`#yearly-4-0`).text(total_amount);
        // 国民健康保険年間所得額
        let insurance = total_amount-43;
        $(`#yearly-4-1`).text(insurance);
        // 課税所得額による所得税率
        let income_tax_rate = total_amount<=195 ? 5 : (total_amount <= 330 ? 10 : (total_amount <= 695 ? 20 : 24));
        $(`#yearly-4-2`).text(`${income_tax_rate}%`);

        let total_tax = tax_amount = 0;
        // 住民税・所得割
        tax_amount = total_amount/10;
        total_tax += tax.eval(tax_amount);
        $(`#yearly-7-2`).text(tax_amount);
        // 個人事業税
        let freelance_tax = (total_amount>=290 ? (total_amount-290)*0.05 : 0).toFixed(1);
        total_tax += tax.eval(freelance_tax);
        $(`#yearly-7-3`).text(freelance_tax);
        // 所得税
        tax_amount = (total_amount*income_tax_rate/100);
        total_tax += tax.eval(tax_amount);
        $(`#yearly-7-4`).text(tax_amount);
        // 合計税金
        $(`#yearly-7-0`).text(total_tax);

        // 年金
        let total_pension = 0;
        // 国民年金
        tax_amount = (1.654*12*$("#nenkin-count").val()).toFixed(1);
        total_pension += tax.eval(tax_amount);
        $(`#yearly-8-1`).text(tax_amount);
        // 合計年金
        $(`#yearly-8-0`).text(total_pension);

        // 保険
        let total_insurance = 0;
        // 加入者情報
        let number_of_persons = number_of_under_40 = number_of_40_65 = number_of_66_75 = number_of_after_75 = 0;
        $(`input[type=text].age`).get().forEach(function(text){
            let $text = $(text);
            let age = $text.val();
            if (age==="") { return ; }

            age = Number(age);
            number_of_persons += 1;
            if (age<40) {
                number_of_under_40 += 1;
            } else if (age<65) {
                number_of_40_65 += 1;
            } else if (age<75) {
                number_of_66_75 += 1;
            } else {
                number_of_after_75 += 1;
            }
        });
        number_of_persons = number_of_persons==0 ? 1 : number_of_persons;

        // 国民健康保険・均等割
        tax_amount = 4.5*number_of_persons;
        total_insurance += Number(tax_amount);
        $(`#yearly-9-2`).text(tax_amount);
        // 国民健康保険・所得割
        tax_amount = (insurance*0.0717).toFixed(1);
        total_insurance += Number(tax_amount);
        $(`#yearly-9-3`).text(tax_amount);
        // 国民健康保険・後期高齢者(支援)
        tax_amount = (insurance*0.0242*number_of_40_65+1.5*number_of_persons).toFixed(1);
        total_insurance += Number(tax_amount);
        $(`#yearly-9-4`).text(tax_amount);
        // 国民健康保険・後期高齢者(介護)
        tax_amount = (insurance*0.0223+1.6*number_of_40_65).toFixed(1);
        total_insurance += Number(tax_amount);
        $(`#yearly-9-5`).text(tax_amount);
        // 合計保険
        $(`#yearly-9-0`).text(total_insurance.toFixed(1));

        // 概要
        // 合計
        let total_payment = (total_tax + total_pension + total_insurance).toFixed(1);
        $(`#yearly-10-1`).text(total_payment);
        let total_after_tax = (total_income-total_payment).toFixed(1);
        $(`#yearly-10-2`).text(total_after_tax);

        // 月額の計算
        $("td.amount.yearly").get().forEach((el)=>{
            let $el = $(el);
            let amount_yearly = $el.text();
            let amount_monthly = amount_yearly ? Number(amount_yearly/12).toFixed(2) : "";
            $el.closest("tr").children("td.amount.monthly").text(amount_monthly);
        });
    },
};
</script>
</html>