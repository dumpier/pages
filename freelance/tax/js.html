<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>年金・保険・税金の計算</title>
	<link href="./res/default.css" rel="stylesheet">
	<script src="./res/config.js"></script>
	<script src="../../res/js/my.js"></script>
</head>
<body>
	<div class="mask"><div class="loader"></div></div>
	<h1>個人事業主の税金計算(自前js版)</h1>
	<div id="page">
		<div id="app" class="flex"></div>
	</div>
</body>

<template id="tax-table">
	<div class="column">
		<table class="table border">
			<thead>
				<tr><th colspan=2 class="diagonal">{usage}</th><th>月間(万円)</th><th>年間(万円)</th></tr>
			</thead>
			<tbody></tbody>
		</table>
	</div>
</template>

<script>
const $ = (selector)=>{ return myjs.instance(selector); };
window.onload=()=>{
	tax.render("#app");
	$("input[type=text].amount, input[type=text].age").on("change", function(){ tax.amount.change(); });
	$(".mask").hide();
}

var tax = tax || {
	render:(selector, items)=>{
		const html = {"raw":""};
		let operator = {};
		(items || config.items).forEach(function(item, i){
			if (myjs.type(item)==="Object") {
				return operator = item;
			} else if (item.length == 0) {
				return tax.embed(selector, html, operator);
			}

			item.forEach(function(name, ii) {
				let css_id = `${i}-${ii}`;
				let input_yearly = operator.editable ? `<input type="text" class="amount" id="input-yearly-${css_id}" value="">` : "";
				if (ii==0) html.raw += `<tr><th colspan=2>${name}</th><td></td><td></td></tr>`;
				if (ii==1) html.raw += `<tr><th rowspan=${item.length-1}></th><td>${name}</td><td class="amount" id="monthly-${css_id}"></td><td id="yearly-${css_id}">${input_yearly}</td></tr>`;
				if (ii>=2) html.raw += `<tr><td>${name}</td><td class="amount" id="monthly-${css_id}"></td><td id="yearly-${css_id}">${input_yearly}</td></tr>`;
			});
		});
	},

	// 生成されたHTMLをテンプレートに埋め込む
	embed:(selector, html, operator)=>{
		// テンプレートからhtmlを取得し、代入する
		let template = $("#tax-table").html();
		template = template.replace(/(<tbody>)(<\/tbody>)/g, "$1"+html.raw+"$2").replace(/{usage}/, operator.title);
		$(selector).append(template);
		// クリアする
		html.raw = "";
	},
};

tax.amount = {
	// 入力が変更された場合
	change:()=>{
		$("#app input[type=text].amount").get().forEach(function(input){
			let css_id = input.id.replace(/input-yearly-/, "");
			let amount = input.value;
			$(`#monthly-${css_id}`).text(amount ? (amount/12).toFixed(1) : "");
		});
	},
}
</script>
</html>