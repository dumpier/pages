<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>年金・保険・税金の計算</title>
	<link href="./res/default.css" rel="stylesheet">
	<script src="../../res/js/my.js"></script>
</head>
<body>
	<div class="mask"><div class="loader"></div></div>
	<h1>個人事業主の税金計算(自前js版)</h1>
	<div id="page">
		<div id="app" class="flex"></div>
	</div>
</body>

<template id="tax-table">
	<div class="column">
		<table class="table border">
			<thead>
				<tr><th colspan=2 class="diagonal">{usage}</th><th>月間(万円)</th><th>年間(万円)</th></tr>
			</thead>
			<tbody></tbody>
		</table>
	</div>
</template>

<template id="tax-line-0">
	<tr><th colspan=2>合計収入</th><td></td><td></td></tr>
</template>
<template id="tax-line-1">
	<tr><th rowspan=2></th><td>売上</td><td></td><td></td></tr>
</template>
<template id="tax-line-2">
	<tr><td>売上（補正）</td><td></td><td></td></tr>
</template>

<script>
const $ = (selector)=>{ return myjs.create(selector); };
window.onload=()=>{
	tax.render("#app");
	$("input[type=text].amount").on("change", function(){ tax.amount.change(); });
	$("input[type=text].age").on("change", function(){ tax.amount.change(); });
	$(".mask").hide();
}

var tax = tax || {
	items:[
		{editable:true, title:"入力用"},
		["収入", "売上", "売上（補正用）"],
		["経費", "経費", "経費（補正用）"],
		["控除", "基礎控除", "青色申告控除", "社会保険料控除", "小規模企業共済等掛金控除", "生命保険料控除", "地震保険料控除", "配偶者控除・配偶者特別控除", "扶養控除", "医療費控除", "控除（補正用）"],
		["課税所得額", "※国民健康保険年間所得額", "※課税所得額による所得税率"],
		[],
		{editable:false, title:"結果表示用"},
		["税金", "住民税・均等割", "住民税・所得割", "個人事業税", "所得税", "消費税", "税金（補正用）"],
		["年金", "国民年金", "年金（補正用）"],
		["保険", "国民健康保険・平等割", "国民健康保険・均等割", "国民健康保険・所得割", "国民健康保険・後期高齢者(支援)", "国民健康保険・後期高齢者(介護)", "保険（補正用）"],
		["概要", "合計支払額（年金・保険・税金）", "手取り額"],
		[],
	],

	render:(selector, items)=>{
		const html = {"raw":""};
		let operator = {};
		(items || tax.items).forEach(function(item, i){
			if (myjs.type(item)==="Object") {
				console.log("is title");
				return operator = item;
			} else if (item.length == 0) {
				console.log("output");
				return tax.embed(selector, html, operator);
			}

			item.forEach(function(name, ii) {
				let css_id = `${i}-${ii}`;
				let input_yearly = operator.editable ? `<input type="text" class="amount" id="input-yearly-${css_id}" value="">` : "";
				if (ii==0) {
					html.raw += `<tr><th colspan=2>${name}</th><td></td><td></td></tr>`;
				} else if (ii==1) {
					html.raw += `<tr><th rowspan=${item.length-1}></th><td>${name}</td><td class="amount" id="monthly-${css_id}"></td><td id="yearly-${css_id}">${input_yearly}</td></tr>`;
				} else {
					html.raw += `<tr><td>${name}</td><td class="amount" id="monthly-${css_id}"></td><td id="yearly-${css_id}">${input_yearly}</td></tr>`;
				}
			});
		});
	},

	// 生成されたHTMLをテンプレートに埋め込む
	embed:(selector, html, operator)=>{
		// テンプレートからhtmlを取得し、代入する
		let template = $("#tax-table").html();
		template = template.replace(/(<tbody>)(<\/tbody>)/g, "$1"+html.raw+"$2").replace(/{usage}/, operator.title);
		$(selector).append(template);
		// クリアする
		html.raw = "";
	},
};

tax.amount = {
	// 入力が変更された場合
	change:()=>{
		$("#app input[type=text].amount").get().forEach(function(input){
			let css_id = input.id.replace(/input-yearly-/, "");
			let amount = input.value;
			$(`#monthly-${css_id}`).text(amount ? (amount/12).toFixed(1) : "");
		});
	},
}
</script>
</html>