<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>年金・保険・税金の計算</title>
	<link href="./res/default.css" rel="stylesheet">
	<script src="./res/config.js"></script>
	<script src="../../res/js/my.js"></script>
</head>
<body>
	<div class="loading"><div class="loader"></div></div>
	<h1>個人事業主の税金計算(自前js版)</h1>
	<div id="content">
		<div id="app" class="flex"></div>
	</div>
</body>

<template id="tax-table">
	<div class="column">
		<table class="table border">
			<thead>
				<tr><th colspan=2 class="diagonal">{usage}</th><th>月間(万円)</th><th>年間(万円)</th></tr>
			</thead>
			<tbody></tbody>
		</table>
	</div>
</template>

<template id="tax-input-age">
	<tr><th rowspan="4"></th><th rowspan="4">加入者年齢</th><td class="right"><input type="text" class="right age" id="age-1" value=""></td><td class="right"><input type="text" class="right age" id="age-2" value=""></td></tr>
	<tr><td class="right"><input type="text" class="right age" id="age-3" value=""></td><td class="right"><input type="text" class="right age" id="age-4" value=""></td></tr>
	<tr><td class="right"><input type="text" class="right age" id="age-4" value=""></td><td class="right"><input type="text" class="right age" id="age-6" value=""></td></tr>
	<tr><td class="right"><input type="text" class="right age" id="age-5" value=""></td><td class="right"><input type="text" class="right age" id="age-8" value=""></td></tr>
</template>


<script>
// myjsの短縮を定義
const $ = (selector)=>{ return myjs.instance(selector); };
window.onload=()=>{
	tax.render("#app");
	$("input[type=text].amount, input[type=text].age").on("change", function(){ tax.input.change(); });
	$(".loading").hide();
	console.log($(".loading").css.class.has("test"));
}

var tax = tax || {
	render:(selector, items)=>{
		const html = {"raw":""};
		let operator = {};
		(items || config.items).forEach(function(item, i){
			if (myjs.type(item)==="Object") return operator = item;
			if (item.length == 0) return tax.assign(selector, html, operator);

			let item_count = item.length - 1;
			item.forEach(function(name, ii) {
				let css_id = `${i}-${ii}`;
				let input_yearly = operator.editable ? `<input type="text" class="amount" id="input-yearly-${css_id}" value="">` : "";
				if (ii==0) html.raw += `<tr><th colspan=2>${name}</th><td></td><td></td></tr>`;
				if (ii==1) html.raw += `<tr><th rowspan=${item_count}></th><td>${name}</td><td class="amount" id="monthly-${css_id}"></td><td class="right" id="yearly-${css_id}">${input_yearly}</td></tr>`;
				if (ii>=2) html.raw += `<tr><td>${name}</td><td class="amount" id="monthly-${css_id}"></td><td class="right" id="yearly-${css_id}">${input_yearly}</td></tr>`;

				if ("保険"===name) {
					html.raw += $("#tax-input-age").html();
				}
			});
		});
	},

	// 生成されたHTMLをテンプレートに埋め込む
	assign:(selector, html, operator)=>{
		// テンプレートからhtmlを取得し、代入する
		let template = $("#tax-table").html().replace(/(<tbody>)(<\/tbody>)/g, "$1"+html.raw+"$2").replace(/{usage}/, operator.title);
		$(selector).append(template);
		html.raw = "";
	},
};

tax.input = {
	// 入力が変更された場合
	change:()=>{
		$("#app input[type=text].amount").get().forEach(function(input){
			let css_id = input.id.replace(/input-yearly-/, "");
			let amount = input.value;
			$(`#monthly-${css_id}`).text(amount ? (amount/12).toFixed(1) : "");
		});
	},
};
</script>
</html>